{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{%block title%}Take Exam{%endblock%}

{%block main_content%}
<div class="container">
<div class="row">
    <div class="col-md-9">
        <h1>{{ exam.course_code }}: {{ exam.title }}</h1>
        <hr>

        <form method="POST" action="">
            {{ form.hidden_tag() }}

            <ol>
            {% for subform in form.questions %}
            <li class="border rounded">
                {{ subform.question_id }}
                {{ subform.single_or_multi }}
                <h4 style="display:inline;">{{ questions[loop.index0].question_text }}</h4>
                <h5 style="display:inline;">{{ questions[loop.index0].points }} points</h5>


                {% if subform.single_or_multi.data == 'multi' %}
                <div>
                    {% for opt in subform.answer_multi %}
                    <div class="form-check">
                        {{ opt(class="form-check-input") }}
                        <label class="form-check-label" for="{{ opt.id }}"><strong>{{ opt.label.text }}</strong></label>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div>
                    {% for opt in subform.answer_single %}
                    <div class="form-check">
                        {{ opt(class="form-check-input") }}
                        <label class="form-check-label" for="{{ opt.id }}"><strong>{{ opt.label.text }}</strong></label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if subform.answer_single.errors %}
                <div class="text-danger">
                    {% for e in subform.answer_single.errors %}{{ e }} {% endfor %}
                </div>
                {% endif %}
                {% if subform.answer_multi.errors %}
                <div class="text-danger">
                    {% for e in subform.answer_multi.errors %}{{ e }} {% endfor %}
                </div>
                {% endif %}
            </li><br>
            {% endfor %}
            </ol>
            <div class="col-md-offset-7 col-md-5">
                {{ form.save(class="btn btn-secondary") }}
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
    <div class="col-md-3">
        <h3 id="timer" data-remaining="{{ remaining_seconds }}">Time Left: --:--:--</h3><br>
        <h3>Max Points: {{ questions | sum(attribute='points') }}</h3><br>
        <h3>Security Settings:</h3>
        <h4>
        <ul>
        {% if exam.security_settings.shuffle %}
            <li>Randomized question order</li>
        {% endif %}
        {% if exam.security_settings.single_session %}
            <li>Single session only</li>
        {% endif %}
        {% if exam.security_settings.no_tab_switching %}
            <li>No tab switching allowed</li>
        {% endif %}
        </ul>
        </h4>

        <script>
        document.addEventListener("DOMContentLoaded", function () {
            let timerEl = document.getElementById("timer");
            let remaining = parseInt(timerEl.dataset.remaining);

            function updateTimer() {
                let h = Math.floor(remaining / 3600);
                let m = Math.floor((remaining % 3600) / 60);
                let s = remaining % 60;
                timerEl.textContent = `Time Left: ${h}:${m}:${s}`;

                if (remaining <= 0) {
                    document.querySelector("form").submit(); // Auto-submit
                } else {
                    remaining--;
                    setTimeout(updateTimer, 1000);
                }
            }

            updateTimer();
        });
        </script>
    </div>
</div>

<script>
setInterval(() => {
    const form = document.querySelector("form");
    const data = new FormData(form);

    fetch("{{ url_for('takeExamBp.autosave') }}", {
        method: "POST",
        body: data
    }).catch(err => console.warn("Autosave failed", err));
}, 10000);  // every 10 seconds
</script>

</div>
{%endblock%}
