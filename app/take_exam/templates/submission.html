{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{%block title%}Take Exam{%endblock%}

{%block main_content%}
<div class="container">
<div class="row">
    <!--Left Section-->
    <div class="col-md-9">
        <h1>{{ exam.course_code }}: {{ exam.title }}</h1>
        <hr>

        <form method="POST" action="">
            {{ form.hidden_tag() }}
            {{ form.submit_flag }}

            <ol>
            {% for subform in form.questions %}
            <li class="border rounded">
                {{ subform.question_id }}
                {{ subform.single_or_multi }}
                <h4 style="display:inline;">{{ questions[loop.index0].question_text }}</h4>
                <h5 style="display:inline;">{{ questions[loop.index0].points }} points</h5>


                {% if subform.single_or_multi.data == 'multi' %}
                <div>
                    {% for opt in subform.answer_multi %}
                    <div class="form-check">
                        {{ opt(class="form-check-input") }}
                        <label class="form-check-label" for="{{ opt.id }}"><strong>{{ opt.label.text }}</strong></label>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div>
                    {% for opt in subform.answer_single %}
                    <div class="form-check">
                        {{ opt(class="form-check-input") }}
                        <label class="form-check-label" for="{{ opt.id }}"><strong>{{ opt.label.text }}</strong></label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if subform.answer_single.errors %}
                <div class="text-danger">
                    {% for e in subform.answer_single.errors %}{{ e }} {% endfor %}
                </div>
                {% endif %}
                {% if subform.answer_multi.errors %}
                <div class="text-danger">
                    {% for e in subform.answer_multi.errors %}{{ e }} {% endfor %}
                </div>
                {% endif %}
            </li><br>
            {% endfor %}
            </ol>
            <div class="col-md-offset-7 col-md-5">
                {{ form.save(class="btn btn-secondary") }}
                <button type="button" class="btn btn-primary" id="submitBtn">Submit</button>
            </div>
        </form>
    </div>

    <!--Right Section-->
    <div class="col-md-3">
        <!--Tab Switch Warning-->
        <div class="alert alert-danger alert-dismissable" id="auto-fade-warning" style="display:none;">
            <strong>WARNING: Tab switching is prohibited! Any further switches will be reported.</strong>
        </div>

        <!--Tab Switch Report-->
        <div class="alert alert-danger alert-dismissable" id="auto-fade-report" style="display:none;">
            <strong>WARNING: Tab switch reported!</strong>
        </div>

        <h3 id="timer" data-remaining="{{ remaining_seconds }}">Time Left: --:--:--</h3><br>
        <h3>Max Points: {{ questions | sum(attribute='points') }}</h3><br>
        <h3>Security Settings:</h3>
        <h4>
        <ul>
        {% if exam.security_settings.shuffle %}
            <li>Randomized question order</li>
        {% endif %}
        {% if exam.security_settings.single_session %}
            <li>Single session only</li>
        {% endif %}
        {% if exam.security_settings.no_tab_switching %}
            <li>No tab switching allowed</li>
        {% endif %}
        </ul>
        </h4>

        <!--stuff from here and bellow was made with A LOT of help from chat-->
        <!--Timer+Autosave+Confirmation+Tab Switch Detection-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const form = document.querySelector("form");
                const submitBtn = document.getElementById("submitBtn");
                const confirmBtn = document.getElementById("confirmSubmit");
                const cancelBtn = document.getElementById("cancelSubmit");
                const modal = document.getElementById("submitConfirmModal");
                const autosaveInterval = {{ interval or 5000 }};
                let timerEl = document.getElementById("timer");
                let feedback = {{ (feedback or "") | tojson }};
                const tab_switch_detection_enabled = {{ exam.security_settings.no_tab_switching | tojson }};
                console.log("Exam script loaded");

                /* Submission Confirmation Behavior */
                if (submitBtn && cancelBtn && confirmBtn) {
                    submitBtn.addEventListener("click", () => $("#submitConfirmModal").modal("show"));
                    cancelBtn.addEventListener("click", () => $("#submitConfirmModal").modal("hide"));

                    confirmBtn.addEventListener("click", () => {
                        document.getElementById("submit_flag").value = "1";
                        form.submit();
                    });
                }
                /* Autosave Definition */
                function autosave(type, payload = null) {
                    let data;
                    if (type === "progress") {
                        data = new FormData(form);
                    }
                    else {
                        data = new FormData();
                        data.append("feedback", payload);
                    }
                    data.append("autosave_type", type);

                    return fetch("{{ url_for('take_examBp.autosave') }}", {
                        method: "POST",
                        body: data
                    }).catch(err => console.warn("Autosave failed", err));
                }

                /* Periodic Autosave */
                window.autosaveInterval = setInterval(() => {
                    autosave("progress").then(() => console.log("Autosaved"));
                }, autosaveInterval);

                /* Timer */
                let remaining = parseInt(timerEl.dataset.remaining || "0", 10);

                function updateTimer() {
                    let h = Math.floor(remaining / 3600);
                    let m = Math.floor((remaining % 3600) / 60);
                    let s = remaining % 60;

                    h = String(h).padStart(2, '0');
                    m = String(m).padStart(2, '0');
                    s = String(s).padStart(2, '0');

                    timerEl.textContent = `Time Left: ${h}:${m}:${s}`;

                    if (remaining <= 0) {
                        timerEl.textContent = "Time Left: 00:00:00";

                        // Run autosave one last time
                        autosave("progress").finally(() => {
                            // Stop autosave interval
                            if (window.autosaveInterval) {
                                clearInterval(window.autosaveInterval);
                            }

                            // Disable inputs
                            document.querySelectorAll("input, button, textarea, select")
                                .forEach(el => el.disabled = true);

                            // Show expiration popup
                            $("#timeUpModal").modal({
                                backdrop: "static",
                                keyboard: false
                            });
                        });

                        return;
                    }

                    remaining--;
                    setTimeout(updateTimer, 1000);
                }

                updateTimer();

                /* Tab Switch Detection */
                if (tab_switch_detection_enabled) {
                    skipInstance = false;
                    window.onbeforeunload = function() {
                        skipInstance = true;
                    };

                    let tabChanges = 0;

                    if (!feedback) {
                        tabChanges = 0;
                    }
                    else if (feedback === "Issued Warning") {
                        tabChanges = 1;
                    }
                    else {
                        let match = feedback.match(/\d+/);
                        tabChanges = match ? parseInt(match[0], 10) : 0;
                    }

                    function fadeOutAlert(id) {
                        const alertBox = document.getElementById(id);
                        if (!alertBox) return;

                        alertBox.style.display = "block";
                        alertBox.style.opacity = "1";

                        setTimeout(() => {
                            alertBox.style.transition = "opacity 1s ease";
                            alertBox.style.opacity = "0";
                            setTimeout(() => alertBox.style.display = "none", 1000);
                        }, 5000);
                    }

                    document.addEventListener("visibilitychange", () => {
                        if (remaining <= 0 || skipInstance) return;

                        if (!document.hidden) {
                            let alert = tabChanges === 1 ? "auto-fade-warning" : "auto-fade-report";
                            fadeOutAlert(alert);

                            return;
                        }

                        tabChanges++;

                        if (tabChanges === 1) feedback = "Issued Warning";
                        else feedback = "Tab Switches: " + tabChanges;

                        autosave("report", feedback);
                    });
                }
            });
        </script>
    </div>
</div>


<!--Confirmation Popup-->
<div class="modal fade" id="submitConfirmModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content" style="text-align:center;">
      <div class="modal-header">
        <h4 class="modal-title">Confirm Submission</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to submit your exam? Once submitted, you cannot make changes.</p>
      </div>
      <div class="modal-footer" style="text-align:center;">
        <button type="button" class="btn btn-default" id="cancelSubmit">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSubmit">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!--Expiration Popup-->
<div class="modal fade" id="timeUpModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content" style="text-align:center;">
      <div class="modal-header">
        <h4 class="modal-title">Timeâ€™s Up</h4>
      </div>
      <div class="modal-body">
        <p>
            Your time for this exam has run out.
            Your attempt has been saved and submitted.
        </p>
      </div>
      <div class="modal-footer" style="text-align:center;">
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            Return to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>



</div>
{%endblock%}
