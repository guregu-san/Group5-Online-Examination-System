{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{%block title%}Take Exam{%endblock%}

{%block main_content%}
<div class="container">
<div class="row">
    <!--Left Section-->
    <div class="col-md-9">
        <h1>{{ exam.course_code }}: {{ exam.title }}</h1>
        <hr>

        <form method="POST" action="">
            {{ form.hidden_tag() }}

            <ol>
            {% for subform in form.questions %}
            <li class="border rounded">
                {{ subform.question_id }}
                {{ subform.single_or_multi }}
                <h4 style="display:inline;">{{ questions[loop.index0].question_text }}</h4>
                <h5 style="display:inline;">{{ questions[loop.index0].points }} points</h5>


                {% if subform.single_or_multi.data == 'multi' %}
                <div>
                    {% for opt in subform.answer_multi %}
                    <div class="form-check">
                        {{ opt(class="form-check-input") }}
                        <label class="form-check-label" for="{{ opt.id }}"><strong>{{ opt.label.text }}</strong></label>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div>
                    {% for opt in subform.answer_single %}
                    <div class="form-check">
                        {{ opt(class="form-check-input") }}
                        <label class="form-check-label" for="{{ opt.id }}"><strong>{{ opt.label.text }}</strong></label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if subform.answer_single.errors %}
                <div class="text-danger">
                    {% for e in subform.answer_single.errors %}{{ e }} {% endfor %}
                </div>
                {% endif %}
                {% if subform.answer_multi.errors %}
                <div class="text-danger">
                    {% for e in subform.answer_multi.errors %}{{ e }} {% endfor %}
                </div>
                {% endif %}
            </li><br>
            {% endfor %}
            </ol>
            <div class="col-md-offset-7 col-md-5">
                {{ form.save(class="btn btn-secondary") }}
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
    <!--Right Section-->
    <div class="col-md-3">
        <h3 id="timer" data-remaining="{{ remaining_seconds }}">Time Left: --:--:--</h3><br>
        <h3>Max Points: {{ questions | sum(attribute='points') }}</h3><br>
        <h3>Security Settings:</h3>
        <h4>
        <ul>
        {% if exam.security_settings.shuffle %}
            <li>Randomized question order</li>
        {% endif %}
        {% if exam.security_settings.single_session %}
            <li>Single session only</li>
        {% endif %}
        {% if exam.security_settings.no_tab_switching %}
            <li>No tab switching allowed</li>
        {% endif %}
        </ul>
        </h4>

        <!--Timer-->
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");

            function runAutosave() {
                const form = document.querySelector("form");
                const data = new FormData(form);

                return fetch("{{ url_for('take_examBp.autosave') }}", {
                    method: "POST",
                    body: data
                }).catch(err => console.warn("Autosave failed", err));
            }

            // Run autosave every 10 seconds
            window.autosaveInterval = setInterval(() => {
                runAutosave().then(() => console.log("Autosaved"));
            }, 10000);

            let timerEl = document.getElementById("timer");
            let remaining = parseInt(timerEl.dataset.remaining);

            function updateTimer() {
              let h = Math.floor(remaining / 3600);
              let m = Math.floor((remaining % 3600) / 60);
              let s = remaining % 60;
              timerEl.textContent = `Time Left: ${h}:${m}:${s}`;

              if (remaining <= 0) {
                timerEl.textContent = "Time Left: 0:0:0";

                // Run autosave one last time
                runAutosave().finally(() => {
                    // Stop autosave interval
                    if (window.autosaveInterval) {
                        clearInterval(window.autosaveInterval);
                    }

                    // Disable inputs
                    document.querySelectorAll("input, button, textarea, select")
                        .forEach(el => el.disabled = true);

                    // Show expiration popup
                    $("#timeUpModal").modal({
                        backdrop: "static",
                        keyboard: false
                    });
                });

                return;
              }

              remaining--;
              setTimeout(updateTimer, 1000);
            }

            updateTimer();
        });
        </script>
    </div>
</div>

<!--Autosave-->
<script>
window.autosaveInterval = setInterval(() => {
    runAutosave();
    console.warn("Autosaved")
}, 10000);
</script>


<!--Expiration Notice-->
<div class="modal fade" id="timeUpModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content" style="text-align:center;">
      <div class="modal-header">
        <h4 class="modal-title">Timeâ€™s Up</h4>
      </div>
      <div class="modal-body">
        <p>
            Your time for this exam has ran out.
            Your attempt has been saved and submitted.
        </p>
      </div>
      <div class="modal-footer" style="text-align:center;">
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            Return to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

</div>
{%endblock%}
