{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}


{%block title%}Exam Initialization{%endblock%}

{%block main_content%}
<div class="card-container">
    <div class="card">
        <h1>{{ exam.title }}</h1>
        <h4>
            Instructor: <p>{{ instructor.name }}</p><br>
            Available:
            <p>
            <span id="availability-display"
            data-open="{{ availability[0].isoformat() | safe }}"
            data-close="{{ availability[1].isoformat() | safe }}">
                {% if availability[0].date() == availability[1].date() %}
                    {{ availability[0].strftime('%d/%m/%y') }}<br>
                    {{ availability[0].strftime('%H:%M') }}
                    -
                    {{ availability[1].strftime('%H:%M') }}
                {% else %}
                    {{ availability[0].strftime('%d/%m/%y %H:%M') }}
                    -
                    {{ availability[1].strftime('%d/%m/%y %H:%M') }}
                {% endif %}
            </span>
            </p><br>

            <!-- Date Formatter-->
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const el = document.getElementById("availability-display");
                    if (!el) return;

                    const open = new Date(el.dataset.open);
                    const close = new Date(el.dataset.close);

                    const fd = d => d.toLocaleDateString("en-GB");
                    const ft = d => d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false });

                    const sameDay =
                        open.getFullYear() === close.getFullYear() &&
                        open.getMonth() === close.getMonth() &&
                        open.getDate() === close.getDate();

                    el.innerHTML = sameDay
                        ? `${fd(open)}<br>${ft(open)} - ${ft(close)}`
                        : `${fd(open)} ${ft(open)} - ${fd(close)} ${ft(close)}`;
                });
            </script>

            Security Settings:<br>
            <p>
            {% if exam.security_settings.shuffle %}
                - Randomized question order<br>
            {% endif %}
            {% if exam.security_settings.single_session %}
                - Single session only<br>
            {% endif %}
            {% if exam.security_settings.no_tab_switching %}
                - No tab switching allowed<br>
            {% endif %}
            </p>
        </h4>
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            {% if not exam_open %}
                <div class="alert alert-warning">
                    <strong>Exam is currently unavailable</strong>
                </div>
                <button type="submit" name="cancel" value="cancel" class="btn btn-primary">
                    Go back
                </button>
            {% else %}
                {% if exam.security_settings.password != '' %}
                    <div class="form-group {% if form.password.errors %}has-error{% endif %}">
                        {{ form.password(class="form-control") }}
                    </div>
                {% endif %}
                {% if form.password.errors %}
                    <div class="alert alert-warning alert-dismissable" id="auto-fade-alert">
                        <strong>Wrong password</strong>
                    </div>

                    <script>
                        setTimeout(function() {
                            let alertBox = document.getElementById("auto-fade-alert");
                            if (alertBox) {
                                alertBox.style.transition = "opacity 1s ease";
                                alertBox.style.opacity = "0";
                                setTimeout(() => alertBox.remove(), 1000);
                            }
                        }, 2500);
                    </script>
                {% endif %}
                {% if taking_exam %}
                    {{ form.continue_submission(class="btn btn-primary") }}
                {% else %}
                    {{ form.accept(class="btn btn-primary") }}
                    {{ form.cancel(class="btn btn-danger") }}
                {% endif %}
            {% endif %}
        </form>
    </div>
</div>
{%endblock%}
