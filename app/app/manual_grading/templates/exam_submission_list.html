{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h3>Submissions for Exam #{{ exam_id }}</h3>

  <!-- Filter & Refresh -->
  <div class="d-flex align-items-center mt-3">
    <label class="me-2 mb-0">Filter by status:</label>
    <select id="statusFilter" class="form-select w-auto">
      <option value="">All</option>
      <option value="SUBMITTED">SUBMITTED</option>
      <option value="IN_REVIEW">IN_REVIEW</option>
      <option value="GRADED">GRADED</option>
    </select>

    <button id="refreshBtn" class="btn btn-secondary btn-sm ms-2">
      Refresh
    </button>
  </div>

  <!-- Error box -->
  <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>

  <!-- Table -->
  <table class="table table-striped mt-3">
    <thead>
      <tr>
        <th>Submission ID</th>
        <th>Roll Number</th>
        <th>Student Name</th>
        <th>Submitted At</th>
        <th>Status</th>
        <th>Total Score</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="submissionsBody">
      <tr>
        <td colspan="7" class="text-center">Loading...</td>
      </tr>
    </tbody>
  </table>

  <a class="btn btn-link mt-3" href="/instructor/grading">
    ‚Üê Back to Manual Grading Dashboard
  </a>
</div>

<!-- Page script: behaves like the React ExamSubmissionsList component -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // exam_id comes from Flask when rendering the template
    const examId = "{{ exam_id }}";

    const statusFilter = document.getElementById("statusFilter");
    const refreshBtn = document.getElementById("refreshBtn");
    const tbody = document.getElementById("submissionsBody");
    const errorBox = document.getElementById("errorBox");

    async function loadSubmissions() {
      errorBox.classList.add("d-none");
      errorBox.textContent = "";

      let url = `/grading/exams/${examId}/submissions`;
      const status = statusFilter.value;
      if (status) {
        url += `?status=${encodeURIComponent(status)}`;
      }

      try {
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        tbody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">No submissions found.</td></tr>';
          return;
        }

        data.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.submission_id}</td>
            <td>${s.roll_number || ""}</td>
            <td>${s.student_name || ""}</td>
            <td>${s.submitted_at || ""}</td>
            <td>${s.status}</td>
            <td>${s.total_score ?? ""}</td>
            <td>
              <a class="btn btn-sm btn-outline-primary"
                 href="/instructor/grading/submissions/${s.submission_id}">
                Review
              </a>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        errorBox.textContent = "Failed to load submissions";
        errorBox.classList.remove("d-none");
        tbody.innerHTML =
          '<tr><td colspan="7" class="text-center">Error loading submissions.</td></tr>';
      }
    }

    refreshBtn.addEventListener("click", loadSubmissions);
    statusFilter.addEventListener("change", loadSubmissions);

    // initial load
    loadSubmissions();
  });
</script>
{% endblock %}
